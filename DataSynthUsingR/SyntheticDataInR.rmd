---
title: "Generating synthetic data using `stpp` package in R"
author: "monsuru"
date: "19 October 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

In R environment, the **stpp** package is the only package that provides the functions for synthesizing point process in space and time over a wide class of models. For the purpose of this post, we will look at three models, namely; the Homogeneous Poisson Process (HPP), Inhomogeneous Poisson Process (IHPP), and Poisson cluster process (PCP). These models are chosen because of their relevance from the viewpoint of crime data analytics. These will be discussed along with their formulations. 

The `rpp` function is used to synthesise point process based on the HPP and IHPP models, while the ` rpcp` function is used to synthesise point process based on the PCP model. In this exercise, the point processes are generated within a 3D region defined spatially by the geographical boundary of South Chicago, and temporally by one year time interval i.e. $t =c(1, 365)$.

**1. Homogeneous Poisson process (HPP)**

The simplest stochastic model for generating STPP. It is generally used as the benchmark of complete spatio-temporal randomness (CSTR). Given a spatio-temporal region $S\times T$, the events form an independent random sample from the uniform distribution on $S\times T$. Hence, a homogenous Poisson process can be defined more formally by the following postulations:
(i)	For some intensity $\lambda \ge 0$, the number $Y(S\times T)$ of events within the region $S\times T$ is defined by a Poisson distribution with mean $\lambda |S||T|$, where $|.|$ denotes 2D area.
(ii)	Given $Y(S\times T)=n$, the events form an independent random sample from the uniform distribution on $S\times T$.

  *Properties:*
The $1^{st}-order$ and $2^{nd}-order$ intensities are the constants, $\lambda(s,t)=\lambda$ and $\lambda_2((s_i,t_i), (s_j,t_j))=\lambda^2$, respectively. The covariance density is identically zero, and the pair correlation function identically 1, and the STIK function is $K_{ST}(u,v)=\pi u^2v$.

  *Simulation Study:*
  
To synthesise a homogeneous Poisson point process in $S\times T$ using the `rpp` function, two steps are involved, namely; (1) Simulate the number $n=Y(S\times T)$ of points according to Poisson distribution with mean $\lambda|S||T|$, and (2) Sample each of the $n$ locations and $n$ times according to a uniform distribution on $S$ and on $T$ respectively.


```{r comment=NA, message=F, warning=F}
library(stpp)
library(maptools)
library(rgeos)
library(splancs)
```

```{r }
#simulating point patterns inside a specified polygon (Boundary of South Chicago defined by two-column coordinates)

bound_area <-  read.table(file="E:/UNIVERSITY OF LEEDS SUBMISSIONS/synthesised data/rmarkdown/bound_coords.csv", sep=",",head=T)
bound_area <-cbind(bound_area[,1], bound_area[,2])
colnames(bound_area) <-c("x","y")
##head(bound_area)
Hpp2 <- rpp(npoints = 1500, s.region=bound_area, t.region = c(1, 365), discrete.time=TRUE)
##head(Hpp2)

```
Output: returns a matrix `xyt` (or a list of matrices if the `nsim>1`), containing the points $(x,y,t)$ of the simulated point patterns within the region `s.region` $(S)$ $\times$ `t.region` $(T)$ 

```{r }
animation(Hpp2$xyt, s.region=Hpp2$s.region)
```

The above is a realisation of the Poisson process with intensity $\lambda=1000/(|S||T|)$, conditioned to produce exactly 1500 points within $S$ (South Chicago boundary), and $T$, between the time interval 1 and 365 days. Coincident times are allowed by the `replace` argument. In the animation, time is treated as a quantitative mark highlighting the currency of the events. The points are fairly evenly distributed across the area.

**2. Inhomogeneous Poisson process (IHPP)**

The IHPP is the simplest non-stationary point process. It is generated by replacing the constant intensity $\lambda$ of the homogeneous Poisson process above by a spatially and/or temporally varying intensity function $\lambda(s,t)$. IHPP can be defined formally by the following postulations: (i) The count of events $Y(S\times T)$ within the region $S\times T$ follows a Poisson distribution with mean $\int_S \int_T \lambda(s,t)dt ds$ (ii) Given $Y(S\times T)=n$, the events form an independent random sample with probability density function $f(s,t)/ \int_S \int_T \lambda(\widetilde{s},\widetilde{t})d\widetilde{t} d\widetilde{s}$.

  *Properties:*
For a Poisson process with intensity $\lambda(s,t)$, the $2^{nd}-order$ intensity is $\lambda_2((s_i,t_i), (s_j,t_j))= \lambda (s_i,t_i)\lambda (s_j,t_j)$, therefore the covariance density and the pair correlation function are identically zero and 1, respectively, and the STIK function $K_{ST}(u,v)=\pi u^2v$ as in the HPP case.

  *Simulation Study:*

Generating an IHPP in $S\times T$, the `rpp` function of **stpp** package is also used with the difference being that the intensity is specified by a `function` of the coordinates and times, $\lambda(x,y,t,...)$. 

Thus, the IHPP provides a framework that makes it possible for the introduction of covariates of inhomogeneity (such as the `daytime population` and/or `nighttime population`) into the analysis of spatiotemporal point patterns via the intensity function. From a statistical point-of-view, the distinction between `clustering` and `heterogeneity` can adequately be sustained if these additional information are available. 

Note: The demonstration here uses the kernel smoothing in Silver [(1986)](http://www.stat.ufl.edu/~rrandles/sta6934/smhandout.pdf) to model the intensity function.


```{r comment=NA, echo=FALSE}
#import boundary coordinates
bound_area <-  read.table(file="E:/UNIVERSITY OF LEEDS SUBMISSIONS/synthesised data/rmarkdown/bound_coords.csv", sep=",",head=T)
bound_area <-cbind(bound_area[,1], bound_area[,2])
colnames(bound_area) <-c("x","y")
##head(bound_area)
```

```{r comment=NA}
#Visualising the dataset
dataC <- read.table(file="E:/UNIVERSITY OF LEEDS SUBMISSIONS/synthesised data/rmarkdown/chicago_burglary.csv", sep=",",head=T)
dataC <-cbind(dataC$x, dataC$y, dataC$date2)
colnames(dataC)<-c("x","y","t")
head(dataC)
```    

```{r comment=NA}


h<-mse2d(as.points(dataC[,1:2]), bound_area, nsmse=30, range = 3000)
h<-h$h[which.min(h$mse)]
Ls<-kernel2d(as.points(dataC[,1:2]), bound_area, h, nx=100, ny =100)
Lt<-dim(dataC)[1]*density(dataC[,3],n=200)$y
Lst<-array(0, dim=c(100, 100, 200))
for(k in 1:200) Lst[, , k] <- Ls$z * Lt[k]/dim(dataC)[1]
IHPP <- rpp (lambda = Lst, s.region=bound_area, t.region =  c(1, 365), discrete.time = TRUE)
image(Ls$x, Ls$y, Ls$z, col=grey((1000:1)/1000), main="A realisation of Inhomo. Poisson process")
polygon(bound_area)
animation(IHPP$xyt, add=TRUE, cex = 0.5, runtime=15)

```
The above is a realisation of the IHPP generated by deriving the spatial and temporal intensities from the chicago burglary crime. The realisation is superimposed on a grey-scale image of the spatial intensity estimate. 

**3. Poisson Cluster Process (PCP)**

This was originally introduced by Neyman and Scott [(1958)]( http://www.jstor.org/stable/pdf/2983905.pdf?refreqid=excelsior%3A020e8dde44827e1c371f9862f146172a), as a model of spatial clustering model based on the following postulations: (i) A set of parent events form a Poisson process with intensity $\lambda(s,t)$, (ii) Each parent produces a random number $N_f$ of offsprings with mean $m_f$, realised independently and identically for each parent, (iii) The Positions and times of the offsprings relative to their parents are `i.i.d` according to a bivariate pdf $f(.)$, (iv) The final process consists of offspring only.

In the `stpp` package, the positions and times of the offsprings are generalised as `i.i.d` according to a trivariate pdf(.) on $\mathbb{R}^2 \times \mathbb{R}^+$.

One potential application of the Poisson Cluster Process is the distribution of certain crime types around the socio-environmental entities that are believed to create the opportunities for the crimes. In Groff and Lockwood [(2014)]( https://scholar.google.co.uk/scholar?dcr=0&um=1&ie=UTF-8&lr&q=related:zgfWWX2PrBfIxM:scholar.google.com/) the locations of facilities such as bars and subway stations (parents) were found to be positively associated with the distribution of violent, property, and disorder crime (offspring) at multiple distance thresholds. 

  *Simulation Study:*
  
Generating a PCP in $S\times T$, the `rpcp` function of **stpp** is used. The function generates points around a number of `parents` points according to the following three steps, namely; (i) Simulate a Poisson process of parent points with intensity $\lambda(s,t)$ in $S'\times S'$, where $S'\subset S$ and $T'\subset T$ to minimise loss of offspring due to parents that are close to the boundary of $S$ and $T$. (ii) For each simulated parent, generate a random number $N_f$ of offspring from a Poisson distribution with mean $m_f$, and lastly, (iii) generate the $ST$ offsets of the offsprings from their respective parents as i.i.d realisation from the trivariate pdf(.) with density $f(.)$.

Generate a number of parent points with `rpp` function as in the example of HPP  or IHHP. Here, the distribution of the parent points in space and time can also be specified from amongst "uniform","normal" and "exponential" function using the argument `"cluster="`. 

```{r }
PCP <- rpcp(nparents = 50, mc = 10, s.region=bound_area, t.region=c(1, 365), cluster=c("normal"), dispersion = c(5000, 5))
```

Note some parameter descriptions:
`dispersion` - a scale parameter (See Gabriel et al. [(2013)]( https://r-forge.r-project.org/scm/viewvc.php/*checkout*/pkg/inst/doc/stpp.pdf?revision=61&root=stpp&pathrev=61)) and `edge` - sets as "larger.region"" (Default)  to generate Poisson cluster process within a larger region than $S\times T$ or "without" to generate the process within $S\times T$. The latter will have artificially reduced intensity near the boundary $S$.

```{r }
animation(PCP$xyt, s.region=PCP$s.region, t.region=PCP$t.region, runtime=5)   
```

In the above example, the parents are generated by a homogeneous ST Poisson process with intensity $\lambda=n_p/(|S||T|)$, where $S$ is the boundary of South Chicago, the time range of the dataset $T=[1, 365]$ and the number of parents $n_p=50$. The number of offsprings that are generated per parent follows a Poisson distribution with mean $m_c$.

## The next exercise is to:

* Compare the properties of the real dataset (Chicago burglary crime) and the synthetic datasets. 
    * How similar or different are the datasets? 
    * Can we synthesise similar processes as the real dataset (for different crime types)?
