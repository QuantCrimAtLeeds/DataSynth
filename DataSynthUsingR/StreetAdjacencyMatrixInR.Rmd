---
title: "Street adjacency matrix"
author: "monsuru"
date: "19 October 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
A street adjacency matrix $M$ is the mathematical representation of the connectivity (relationships) between the segments of a street network. In geographical data analysis, it might be important to know which segments (edges) in a network are connected to one another, in order to model the propagation of a geographical phenomenon such as crime risk or traffic flow across the network. The adjacency matrix ($n \times n$) provides a simple way of defining such connectivity with an entry "1" for any pair of segments that are directly connected to the same node, and "0" if they are not. Figure 1 is an example of an adjacency matrix of a network comprising seven segments. 

<center>![](https://github.com/QuantCrimAtLeeds/DataSynth/blob/master/DataSynthUsingR/resources/Adj_Matrix.jpg?raw=true)</center>
<center>Figure 1. A sample street network and its adjacency matrix</center>

The above matrix is regarded as the 1st-order adjacency matrix of the network. Similarly, one may define the 2nd-order adjacency, 3rd-order adjacency and so on, depending on the application. The connection between segment 3 and segment 7 relative to segment 1 is considered a 2nd-order adjacency because both segments are not directly connected segment 1 but to its 1st-order segments. The connection between segment 1 and segment 4 is an example of a 3rd-order adjacency, and so on. The idea of adjacency matrix has been applied in transport studies [Anbaroglu et al., 2014]( https://ac.els-cdn.com/S0968090X14002186/1-s2.0-S0968090X14002186-main.pdf?_tid=a7e818f0-b716-11e7-a475-00000aacb35f&acdnat=1508669539_bc0345a87773208b4edda25ee5935c65) to define the flow of traffic across a network.

In other studies involving air and railway journeys, the connectivity may be defined in relation to the nodes (cities or stations). It might be important to know if it is possible to get from one node to another, without reference to the distance between them. While this question is relatively easy to answer for a small graph, it becomes harder as the number of nodes and edges grow. The adjacency matrix can help to simplify the answers to such a question.

Given a street network shapefile (.shp), the below R script can be used to generate an adjacency matrix $M$ for the shapefile. If the order specified is greater than 1, an array $M[n \times n \times r]$ is generated, where $n$ is the number of segments in the network and $r$ is the order. The output is generated as a .RData.

**import the libraries**
```{r comment=NA, message=F, warning=F}
library(rgdal)
library(igraph)
library(abind)
```

The 'igraph' in R provides a number of functions that could be used to construct the Adjacency matrix of this network. The igraph library is also available in Python

```{r }
#import the street network
setwd("F:/UNIVERSITY OF LEEDS SUBMISSIONS/synthesised data/rmarkdown/shapefiles/")
road_Network <- readOGR(dsn=".", layer="road_Network")  
#visualising the road network
```
<center>![](https://github.com/QuantCrimAtLeeds/DataSynth/blob/master/DataSynthUsingR/resources/Street_Net.jpg?raw=true)</center>

<center>Figure 2. A portion of South Chicago's street network</center>



To construct the Adjacency matrix, there is a need to first extract the nodes connections between the segments. The below codes achieves this.

```{r comment=NA, message=F, warning=F}
#Generating the start- and end- nodes for each segment 
res <- lapply(slot(road_Network, "lines"), function(x) lapply(slot(x, "Lines"),
   function(y) slot(y, "coords")))

uniqueIDs <- NULL
for(i in 1:length(res)){ #222
x1 <- res[[i]][[1]][1,1]
y1<-  res[[i]][[1]][1,2]
x2 <- res[[i]][[1]][nrow(res[[i]][[1]]),1]
y2<-  res[[i]][[1]][nrow(res[[i]][[1]]),2]
xy1 <- paste(trunc(x1),trunc(y1),sep="")
xy2 <- paste(trunc(x2),trunc(y2),sep="")
uniqueIDs <- rbind(uniqueIDs, xy1, xy2)
}#222
uni_IDs <- unique(uniqueIDs)

#----------------------------
road_Network_Database <- NULL
#--------------------------------------
for(i in 1:length(res)){	#9999

	x1 <- res[[i]][[1]][1,1]
	y1<-  res[[i]][[1]][1,2]

	x2 <- res[[i]][[1]][nrow(res[[i]][[1]]),1]
	y2<-  res[[i]][[1]][nrow(res[[i]][[1]]),2]

	xy1 <- paste(trunc(x1),trunc(y1),sep="")
	xy2 <- paste(trunc(x2),trunc(y2),sep="")
	
	road_Network_Database <- rbind(road_Network_Database, cbind(i,  which(uni_IDs[,1]== xy1), which(uni_IDs[,1]== xy2)))
	
} #9999

road_Network_Database <- data.frame(road_Network_Database)
colnames(road_Network_Database) <- c("id", "Start_Node", "End_Node")
head(road_Network_Database)

```

**Specify the number of adjacency order to generate**

NumOrder <- 3


